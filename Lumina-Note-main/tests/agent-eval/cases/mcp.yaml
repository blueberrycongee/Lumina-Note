# MCP (Model Context Protocol) 功能测试用例
# 从用户角度测试 MCP Server 集成功能

# ============ MCP 配置管理 ============

- id: mcp_config_001
  name: "查看 MCP 服务器状态"
  category: mcp
  input: "看看有哪些 MCP 服务器"
  description: |
    用户想了解当前配置了哪些 MCP 服务器，以及它们的连接状态。
    这是用户管理 MCP 功能的入口。
  expectedBehavior:
    - 列出所有配置的 MCP 服务器
    - 显示每个服务器的连接状态（已连接/已断开/已禁用）
    - 显示每个服务器提供的工具数量
  expectedOutcome: "返回 MCP 服务器列表及状态"

- id: mcp_config_002
  name: "查看 MCP 工具列表"
  category: mcp
  input: "MCP 服务器有什么工具可以用"
  description: |
    用户想知道通过 MCP 可以使用哪些额外的工具。
  expectedBehavior:
    - 列出所有已连接服务器的工具
    - 显示工具名称和描述
    - 按服务器分组展示
  expectedOutcome: "返回可用的 MCP 工具列表"

# ============ 文件系统 MCP Server ============

- id: mcp_filesystem_001
  name: "通过 MCP 读取外部文件"
  category: mcp
  input: "用 MCP 读取 /tmp/test.txt 的内容"
  description: |
    用户想通过 MCP filesystem server 读取笔记库外部的文件。
    这是 MCP 的核心价值之一：扩展 Agent 的能力边界。
  precondition:
    - filesystem MCP server 已配置并连接
    - /tmp/test.txt 文件存在
  expectedTools:
    - mcp_filesystem__read_file
  expectedOutcome: "返回外部文件的内容"

- id: mcp_filesystem_002
  name: "通过 MCP 列出外部目录"
  category: mcp
  input: "看看 /home/user/documents 目录下有什么"
  description: |
    用户想浏览笔记库外部的目录结构。
  precondition:
    - filesystem MCP server 已配置
    - 目录在 server 的允许范围内
  expectedTools:
    - mcp_filesystem__list_directory
  expectedOutcome: "返回目录内容列表"

- id: mcp_filesystem_003
  name: "通过 MCP 写入外部文件"
  category: mcp
  input: "用 MCP 在 /tmp 目录创建一个 hello.txt，内容是 Hello World"
  description: |
    用户想通过 MCP 在外部位置创建文件。
    这个操作应该需要用户审批（除非在 autoApprove 列表中）。
  precondition:
    - filesystem MCP server 已配置
    - /tmp 在允许写入的目录范围内
  expectedTools:
    - mcp_filesystem__write_file
  expectedApproval: true
  expectedOutcome: "文件被创建"

# ============ 搜索类 MCP Server ============

- id: mcp_search_001
  name: "通过 MCP 进行网络搜索"
  category: mcp
  input: "帮我搜索一下 Rust 异步编程的最佳实践"
  description: |
    用户想通过 MCP 搜索服务器（如 brave-search）进行网络搜索。
    这扩展了 Agent 获取信息的能力。
  precondition:
    - brave-search 或类似搜索 MCP server 已配置
  expectedTools:
    - mcp_brave-search__search
  expectedOutcome: "返回搜索结果"

- id: mcp_search_002
  name: "搜索并整理到笔记"
  category: mcp
  input: "搜索 React 18 新特性，然后帮我整理成一篇笔记"
  description: |
    用户想结合 MCP 搜索能力和本地笔记创建能力。
    这是 MCP 与本地工具协作的典型场景。
  precondition:
    - 搜索 MCP server 已配置
  expectedTools:
    - mcp_brave-search__search
    - create_note
  expectedOutcome: "创建包含搜索结果整理的笔记"

# ============ 数据库类 MCP Server ============

- id: mcp_database_001
  name: "通过 MCP 查询数据库"
  category: mcp
  input: "查一下数据库里最近的订单记录"
  description: |
    用户想通过 MCP 数据库服务器查询外部数据库。
  precondition:
    - 数据库 MCP server 已配置并连接
  expectedTools:
    - mcp_postgres__query
  expectedOutcome: "返回查询结果"

# ============ 混合场景 ============

- id: mcp_mixed_001
  name: "MCP 工具与本地工具混合使用"
  category: mcp
  input: "读取 /tmp/data.json 的内容，然后把里面的待办事项添加到我的 todo.md 笔记里"
  description: |
    用户需要同时使用 MCP 工具（读取外部文件）和本地工具（编辑笔记）。
    测试 Agent 能否正确协调不同来源的工具。
  precondition:
    - filesystem MCP server 已配置
    - /tmp/data.json 存在且包含待办事项
    - todo.md 笔记存在
  expectedTools:
    - mcp_filesystem__read_file
    - read_note
    - edit_note
  expectedOutcome: "外部数据被整合到笔记中"

- id: mcp_mixed_002
  name: "搜索外部信息补充笔记"
  category: mcp
  input: "我的 rust-notes.md 里提到了 tokio，帮我搜索一下 tokio 的最新版本信息，补充到笔记里"
  description: |
    用户想基于笔记内容进行外部搜索，然后更新笔记。
    这是知识管理的典型工作流。
  precondition:
    - 搜索 MCP server 已配置
    - rust-notes.md 存在
  expectedTools:
    - read_note
    - mcp_brave-search__search
    - edit_note
  expectedOutcome: "笔记被更新，包含最新信息"

# ============ 错误处理 ============

- id: mcp_error_001
  name: "MCP 服务器未连接时的处理"
  category: mcp
  input: "用 MCP 读取 /tmp/test.txt"
  description: |
    当用户请求使用 MCP 功能但服务器未连接时，
    Agent 应该给出清晰的错误提示。
  precondition:
    - filesystem MCP server 已配置但未连接
  expectedBehavior:
    - 识别到需要使用 MCP 工具
    - 发现服务器未连接
    - 给出友好的错误提示
  expectedOutcome: "提示用户 MCP 服务器未连接"

- id: mcp_error_002
  name: "MCP 工具调用失败的处理"
  category: mcp
  input: "读取 /nonexistent/path/file.txt"
  description: |
    当 MCP 工具调用失败时（如文件不存在），
    Agent 应该正确处理错误并告知用户。
  precondition:
    - filesystem MCP server 已连接
    - 目标文件不存在
  expectedBehavior:
    - 调用 MCP 工具
    - 收到错误响应
    - 向用户解释错误原因
  expectedOutcome: "提示文件不存在"

- id: mcp_error_003
  name: "无可用 MCP 服务器时的降级"
  category: mcp
  input: "搜索一下 Python 教程"
  description: |
    当没有配置搜索类 MCP 服务器时，
    Agent 应该使用本地搜索或告知用户限制。
  precondition:
    - 没有配置搜索类 MCP server
  expectedBehavior:
    - 识别到搜索意图
    - 发现没有外部搜索能力
    - 使用本地 search_notes 或告知用户
  expectedOutcome: "使用本地搜索或提示无外部搜索能力"

# ============ 权限与审批 ============

- id: mcp_approval_001
  name: "危险 MCP 操作需要审批"
  category: mcp
  input: "删除 /tmp/test.txt"
  description: |
    对于危险的 MCP 操作（如删除文件），
    应该触发用户审批流程。
  precondition:
    - filesystem MCP server 已配置
    - delete_file 不在 autoApprove 列表中
  expectedBehavior:
    - 识别到删除操作
    - 触发审批请求
    - 等待用户确认
  expectedApproval: true
  expectedOutcome: "用户审批后执行删除"

- id: mcp_approval_002
  name: "autoApprove 列表中的操作自动执行"
  category: mcp
  input: "读取 /tmp/test.txt"
  description: |
    对于在 autoApprove 列表中的操作，
    应该自动执行无需用户确认。
  precondition:
    - filesystem MCP server 已配置
    - read_file 在 autoApprove 列表中
  expectedBehavior:
    - 识别到读取操作
    - 检查 autoApprove 配置
    - 自动执行无需审批
  expectedApproval: false
  expectedOutcome: "直接返回文件内容"

# ============ 服务器管理 ============

- id: mcp_manage_001
  name: "启动 MCP 服务器"
  category: mcp
  input: "启动 filesystem MCP 服务器"
  description: |
    用户想手动启动一个已配置但未连接的 MCP 服务器。
  precondition:
    - filesystem server 已配置但 disabled 或未启动
  expectedBehavior:
    - 找到对应的服务器配置
    - 启动服务器进程
    - 完成初始化握手
    - 获取工具列表
  expectedOutcome: "服务器启动成功，显示可用工具数量"

- id: mcp_manage_002
  name: "停止 MCP 服务器"
  category: mcp
  input: "停止 brave-search 服务器"
  description: |
    用户想停止一个正在运行的 MCP 服务器。
  precondition:
    - brave-search server 正在运行
  expectedBehavior:
    - 找到对应的服务器
    - 关闭连接
    - 清理资源
  expectedOutcome: "服务器已停止"

- id: mcp_manage_003
  name: "重新加载 MCP 配置"
  category: mcp
  input: "重新加载 MCP 配置"
  description: |
    用户修改了 mcp.json 配置文件后，想重新加载配置。
  expectedBehavior:
    - 关闭所有现有连接
    - 重新读取配置文件
    - 启动新配置的服务器
  expectedOutcome: "配置已重新加载"
