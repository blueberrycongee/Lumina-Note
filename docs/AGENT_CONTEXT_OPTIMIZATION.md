# Agent ä¸Šä¸‹æ–‡ä¼˜åŒ–ï¼šå‘ Aider å­¦ä¹ 

> åŸºäºå¯¹ [Aider](https://github.com/Aider-AI/aider) æºç çš„æ·±åº¦åˆ†æï¼Œåˆ¶å®š Lumina Note Agent çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚

## ğŸ¯ æœ€ç»ˆç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

1. **åŠ é€Ÿ Agent å“åº”** - å‡å°‘ LLM å¤„ç†æ—¶é—´ 50%+
2. **åŠ é€Ÿ Deep Research** - ç ”ç©¶ä»»åŠ¡æ•´ä½“è€—æ—¶é™ä½ 40%+
3. **é™ä½ Token æˆæœ¬** - å‡å°‘ API è°ƒç”¨è´¹ç”¨ 50%+
4. **æå‡å‡†ç¡®æ€§** - æ›´ç²¾å‡†çš„ä¸Šä¸‹æ–‡å¸¦æ¥æ›´å¥½çš„è¾“å‡ºè´¨é‡

### ä¸ºä»€ä¹ˆèƒ½åŠ é€Ÿï¼Ÿ

| ä¼˜åŒ–ç‚¹ | åŠ é€ŸåŸç† | é¢„æœŸæ”¶ç›Š |
|--------|---------|---------|
| **å‡å°‘è¾“å…¥ Token** | LLM å¤„ç†æ›´å°‘å†…å®¹ï¼Œæ¨ç†æ›´å¿« | å“åº”æ—¶é—´ -30~50% |
| **å‡å°‘è¾“å‡º Token** | ç²¾ç¡®ç¼–è¾‘æ ¼å¼ï¼Œä¸éœ€è¦è¾“å‡ºå…¨æ–‡ | è¾“å‡ºæ—¶é—´ -50% |
| **å‡å°‘ç½‘ç»œä¼ è¾“** | æ›´å°çš„è¯·æ±‚/å“åº”ä½“ | ç½‘ç»œå»¶è¿Ÿ -20% |
| **å‡å°‘é‡è¯•** | æ›´ç²¾å‡†çš„ä¸Šä¸‹æ–‡ï¼ŒLLM ä¸"è¿·è·¯" | é‡è¯•æ¬¡æ•° -70% |
| **å¹¶è¡Œå¤„ç†** | Note Map è®© LLM ä¸€æ¬¡çœ‹æ¸…å…¨å±€ | å·¥å…·è°ƒç”¨æ¬¡æ•° -40% |

### å…·ä½“æŒ‡æ ‡ç›®æ ‡

| åœºæ™¯ | å½“å‰è€—æ—¶ | ç›®æ ‡è€—æ—¶ | ä¼˜åŒ–å¹…åº¦ |
|------|---------|---------|---------|
| Agent å•æ¬¡å“åº” | ~10s | ~5s | -50% |
| è¯»å–ç¬”è®° (read_note) | å…¨é‡è¯»å– | æŒ‰éœ€è¯»å– | Token -80% |
| Deep Research å®Œæ•´æµç¨‹ | ~3min | ~1.5min | -50% |
| ç¼–è¾‘ç¬”è®°æˆåŠŸç‡ | ~70% | ~95% | +25% |

---

## ç›®å½•

1. [èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–](#èƒŒæ™¯ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–)
2. [Aider ä¸ºä»€ä¹ˆæ•ˆæœå¥½](#aider-ä¸ºä»€ä¹ˆæ•ˆæœå¥½)
3. [Aider æ ¸å¿ƒå®ç°è¯¦è§£](#aider-æ ¸å¿ƒå®ç°è¯¦è§£)
4. [Lumina Note ç°çŠ¶åˆ†æ](#lumina-note-ç°çŠ¶åˆ†æ)
5. [å·®è·å¯¹æ¯”](#å·®è·å¯¹æ¯”)
6. [æ”¹é€ è®¡åˆ’](#æ”¹é€ è®¡åˆ’)

---

## èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–

### å½“å‰é—®é¢˜

ç°ä»£ AI IDEï¼ˆCursorã€Windsurfã€Aiderï¼‰éƒ½åœ¨ä½¿ç”¨å„ç§æŠ€æœ¯ä¼˜åŒ– LLM çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œè€Œæˆ‘ä»¬çš„ Agent ç³»ç»Ÿå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å…¨é‡å–‚ç»™ LLM**ï¼š`read_note` å·¥å…·ç›´æ¥è¿”å›æ•´ä¸ªæ–‡ä»¶å†…å®¹
2. **æ²¡æœ‰å¤§çº²æŠ½è±¡**ï¼šæ²¡æœ‰æå–ç¬”è®°ç»“æ„ï¼ŒLLM æ— æ³•"å…ˆçœ‹ç›®å½•å†æ·±å…¥"
3. **Token æµªè´¹**ï¼šå¤§é‡æ— å…³å†…å®¹å ç”¨å®è´µçš„ä¸Šä¸‹æ–‡çª—å£
4. **æ²¡æœ‰æ™ºèƒ½æ’åº**ï¼šä¸çŸ¥é“å“ªäº›ç¬”è®°æ›´é‡è¦

### ä¼˜åŒ–ç›®æ ‡

- **ğŸš€ åŠ é€Ÿå“åº”** - Agent å’Œ Research é€Ÿåº¦æå‡ 50%
- **ğŸ’° é™ä½æˆæœ¬** - Token æ¶ˆè€—å‡å°‘ 50%+
- **ğŸ¯ æé«˜ç²¾åº¦** - åªç»™ LLM çœ‹å®ƒéœ€è¦çš„ï¼Œå‡å°‘"å¹»è§‰"
- **ğŸ“š æ¸è¿›å¼é˜…è¯»** - æ”¯æŒ"å…ˆç´¢å¼•åæ·±å…¥"çš„æ™ºèƒ½é˜…è¯»æ¨¡å¼

---

## Aider ä¸ºä»€ä¹ˆæ•ˆæœå¥½

### æ ¸å¿ƒç†å¿µ

> **GPT doesn't need to see the entire implementation, it just needs to understand it well enough to use it.**

Aider çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šLLM ä¸éœ€è¦çœ‹å…¨éƒ¨ä»£ç ï¼Œåªéœ€è¦çœ‹**è¶³å¤Ÿç†è§£**çš„éƒ¨åˆ†ã€‚

### å…­å¤§æˆåŠŸå› ç´ 

#### 1. Repo Mapï¼ˆä»£ç åº“åœ°å›¾ï¼‰

ä¸æ˜¯å‘é€å…¨éƒ¨ä»£ç ï¼Œè€Œæ˜¯å‘é€**ä»£ç ç»“æ„æ‘˜è¦**ï¼š

```
aider/coders/base_coder.py:
â‹®...
â”‚class Coder:
â”‚    abs_fnames = None
â‹®...
â”‚    @classmethod
â”‚    def create(self, main_model, edit_format, ...):
â‹®...
â”‚    def get_repo_map(self, force_refresh=False):
â‹®...
```

- `â‹®` è¡¨ç¤ºçœç•¥çš„ä»£ç 
- åªæ˜¾ç¤ºç±»åã€å‡½æ•°ç­¾å
- å¸¦è¡Œå·ï¼Œæ–¹ä¾¿ LLM å®šä½

#### 2. Tree-sitter AST è§£æ

ä½¿ç”¨ tree-sitter è§£æä»£ç ï¼Œæå–ï¼š
- **å®šä¹‰ (definitions)**ï¼šå‡½æ•°ã€ç±»ã€å˜é‡å®šä¹‰
- **å¼•ç”¨ (references)**ï¼šå‡½æ•°è°ƒç”¨ã€å˜é‡ä½¿ç”¨

```python
Tag = namedtuple("Tag", "rel_fname fname line name kind")
# kind = "def" | "ref"
```

#### 3. PageRank æ™ºèƒ½æ’åº

ä½¿ç”¨å›¾ç®—æ³•è®¡ç®—ä»£ç é‡è¦æ€§ï¼š

```python
import networkx as nx

G = nx.MultiDiGraph()
# èŠ‚ç‚¹ = æ–‡ä»¶
# è¾¹ = å¼•ç”¨å…³ç³»ï¼ˆreferencer â†’ definerï¼‰

# æƒé‡å€ç‡
mul = 1.0
if ident in mentioned_idents: mul *= 10    # ç”¨æˆ·æåˆ°çš„æ ‡è¯†ç¬¦
if is_camelCase and len >= 8: mul *= 10    # æœ‰æ„ä¹‰çš„å‘½å
if ident.startswith("_"): mul *= 0.1       # ç§æœ‰æ ‡è¯†ç¬¦
if referencer in chat_fnames: mul *= 50    # å½“å‰ç¼–è¾‘çš„æ–‡ä»¶

ranked = nx.pagerank(G, weight="weight", personalization=...)
```

#### 4. Token é¢„ç®—æ§åˆ¶

ä½¿ç”¨äºŒåˆ†æœç´¢æ‰¾åˆ°æœ€ä¼˜çš„å†…å®¹é‡ï¼š

```python
# ç›®æ ‡: max_map_tokens (é»˜è®¤ 1024)
while lower_bound <= upper_bound:
    tree = self.to_tree(ranked_tags[:middle])
    num_tokens = self.token_count(tree)
    
    if num_tokens < max_map_tokens:
        lower_bound = middle + 1
    else:
        upper_bound = middle - 1
```

#### 5. åˆ†å±‚æ¶ˆæ¯æ¶æ„ (ChatChunks)

```python
chunks = ChatChunks()
chunks.system       # ç³»ç»Ÿæç¤ºï¼ˆè§’è‰² + ç¼–è¾‘æ ¼å¼è§„åˆ™ï¼‰
chunks.examples     # Few-shot ç¤ºä¾‹
chunks.done         # å†å²å¯¹è¯æ‘˜è¦
chunks.repo         # Repo Mapï¼ˆä»£ç åº“ç»“æ„ï¼‰
chunks.readonly     # åªè¯»å‚è€ƒæ–‡ä»¶
chunks.chat_files   # å½“å‰ç¼–è¾‘çš„æ–‡ä»¶ï¼ˆå®Œæ•´å†…å®¹ï¼‰
chunks.cur          # å½“å‰å¯¹è¯
chunks.reminder     # æ ¼å¼æé†’
```

#### 6. æ¸è¿›å¼æ·±å…¥æœºåˆ¶

```
ç¬¬ä¸€æ¬¡ï¼šåªå‘é€ Repo Mapï¼ˆä»£ç éª¨æ¶ï¼‰
        â†“
LLM: "æˆ‘éœ€è¦çœ‹ user_service.py çš„å®Œæ•´å†…å®¹"
        â†“
ç”¨æˆ·: /add user_service.py
        â†“
ç¬¬äºŒæ¬¡ï¼šå‘é€å®Œæ•´æ–‡ä»¶å†…å®¹
        â†“
LLM: è¾“å‡ºç²¾ç¡®çš„ SEARCH/REPLACE ç¼–è¾‘
```

---

## Aider æ ¸å¿ƒå®ç°è¯¦è§£

### æ–‡ä»¶ç»“æ„

```
aider/
â”œâ”€â”€ repomap.py              # æ ¸å¿ƒï¼šRepo Map ç”Ÿæˆ
â”œâ”€â”€ coders/
â”‚   â”œâ”€â”€ base_coder.py       # åŸºç¡€ Coder ç±»ï¼ˆæ¶ˆæ¯æ„å»ºï¼‰
â”‚   â”œâ”€â”€ base_prompts.py     # æç¤ºè¯æ¨¡æ¿
â”‚   â”œâ”€â”€ editblock_prompts.py # SEARCH/REPLACE æ ¼å¼
â”‚   â””â”€â”€ chat_chunks.py      # åˆ†å±‚æ¶ˆæ¯ç»“æ„
â””â”€â”€ queries/                # Tree-sitter æŸ¥è¯¢æ–‡ä»¶
    â”œâ”€â”€ python-tags.scm
    â”œâ”€â”€ javascript-tags.scm
    â””â”€â”€ ...
```

### RepoMap æ ¸å¿ƒæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Tree-sitter è§£æ                                        â”‚
â”‚     - éå†æ‰€æœ‰æºæ–‡ä»¶                                         â”‚
â”‚     - ä½¿ç”¨ .scm æŸ¥è¯¢æ–‡ä»¶æå–å®šä¹‰å’Œå¼•ç”¨                        â”‚
â”‚     - ç»“æœ: Tag(fname, name, kind="def"|"ref", line)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ„å»ºå¼•ç”¨å›¾                                               â”‚
â”‚     - èŠ‚ç‚¹ = æ–‡ä»¶                                            â”‚
â”‚     - è¾¹ = referencer â†’ definer                             â”‚
â”‚     - è¾¹æƒé‡ = å¼•ç”¨æ¬¡æ•° Ã— é‡è¦æ€§å€ç‡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. PageRank æ’åº                                           â”‚
â”‚     - è®¡ç®—æ¯ä¸ªæ–‡ä»¶/ç¬¦å·çš„é‡è¦æ€§åˆ†æ•°                           â”‚
â”‚     - ä¼˜å…ˆæ˜¾ç¤ºè¢«å¼•ç”¨æœ€å¤šçš„å®šä¹‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Token é¢„ç®—è£å‰ª                                          â”‚
â”‚     - äºŒåˆ†æœç´¢æ‰¾åˆ°æœ€ä¼˜ tag æ•°é‡                              â”‚
â”‚     - ç›®æ ‡: max_map_tokens (é»˜è®¤ 1024)                      â”‚
â”‚     - å…è®¸ 15% è¯¯å·®                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. TreeContext æ¸²æŸ“                                        â”‚
â”‚     - æ”¶é›† lines_of_interest (é‡è¦è¡Œ)                       â”‚
â”‚     - æ·»åŠ å¿…è¦çš„çˆ¶çº§ä¸Šä¸‹æ–‡                                   â”‚
â”‚     - ç”¨ â‹® è¡¨ç¤ºçœç•¥çš„ä»£ç                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tree-sitter æŸ¥è¯¢ç¤ºä¾‹

```scheme
; python-tags.scm
(class_definition
  name: (identifier) @name.definition.class)

(function_definition
  name: (identifier) @name.definition.function)

(call
  function: (identifier) @name.reference.call)
```

### æ¶ˆæ¯æ„å»ºæµç¨‹

```python
def format_chat_chunks(self):
    chunks = ChatChunks()
    
    # 1. ç³»ç»Ÿæç¤º
    chunks.system = [dict(role="system", content=main_sys)]
    
    # 2. Few-shot ç¤ºä¾‹
    chunks.examples = example_messages
    
    # 3. å†å²æ‘˜è¦
    chunks.done = self.done_messages
    
    # 4. Repo Mapï¼ˆå…³é”®ï¼ï¼‰
    chunks.repo = self.get_repo_messages()
    # â†’ "Here are summaries of some files..."
    # â†’ LLM å›å¤: "Ok, I won't edit without asking first."
    
    # 5. åªè¯»æ–‡ä»¶
    chunks.readonly = self.get_readonly_files_messages()
    
    # 6. å½“å‰ç¼–è¾‘æ–‡ä»¶ï¼ˆå®Œæ•´å†…å®¹ï¼‰
    chunks.chat_files = self.get_chat_files_messages()
    
    # 7. å½“å‰å¯¹è¯
    chunks.cur = self.cur_messages
    
    # 8. æ ¼å¼æé†’ï¼ˆé˜²æ­¢ LLM å¿˜è®°è§„åˆ™ï¼‰
    chunks.reminder = reminder_message
    
    return chunks
```

### SEARCH/REPLACE ç¼–è¾‘æ ¼å¼

```
mathweb/flask/app.py
```python
<<<<<<< SEARCH
def factorial(n):
    if n == 0:
        return 1
    return n * factorial(n-1)
=======
import math

def factorial(n):
    return math.factorial(n)
>>>>>>> REPLACE
```

**ä¼˜ç‚¹**ï¼š
- ç²¾ç¡®å®šä½è¦ä¿®æ”¹çš„ä»£ç 
- å‡å°‘è¾“å‡º token
- å®¹æ˜“éªŒè¯å’Œå›æ»š
- æ”¯æŒè‡ªä¿®å¤ï¼ˆåŒ¹é…å¤±è´¥æ—¶é‡è¯•ï¼‰

---

## Lumina Note ç°çŠ¶åˆ†æ

### Deep Researchï¼ˆæ·±åº¦ç ”ç©¶ï¼‰

**ä½ç½®**: `src-tauri/src/agent/deep_research/nodes.rs`

```rust
// read_notes_node: è¯»å–ç¬”è®°
let content = tokio::fs::read_to_string(&full_path).await?;

// é—®é¢˜1: å…¨é‡è¯»å–
// é—®é¢˜2: åªæ˜¯ç®€å•æˆªå–å‰ 3000 å­—ç¬¦ç”Ÿæˆæ‘˜è¦
let summary = if content.len() > 1000 {
    let summary_prompt = format!(
        "è¯·ç”¨ 2-3 å¥è¯æ€»ç»“ä»¥ä¸‹ç¬”è®°çš„ä¸»è¦å†…å®¹ï¼š\n\n{}",
        content.chars().take(3000).collect::<String>()
    );
    llm.call_simple(&summary_prompt).await?
};

// é—®é¢˜3: å†™æŠ¥å‘Šæ—¶æ¯ç¯‡ç¬”è®°æˆªå–å‰ 2000 å­—ç¬¦
let content_preview = n.content.chars().take(2000).collect::<String>();
```

### æ™®é€š Agentï¼ˆread_note å·¥å…·ï¼‰

**ä½ç½®**: `src-tauri/src/agent/tools/registry.rs`

```rust
async fn read_note(&self, params: ...) -> Result<String, String> {
    let content = tokio::fs::read_to_string(&full_path).await?;
    
    // é—®é¢˜: ç›´æ¥è¿”å›å…¨é‡å†…å®¹ï¼ŒåªåŠ äº†è¡Œå·
    let numbered = content.lines()
        .enumerate()
        .map(|(i, line)| format!("{:4} | {}", i + 1, line))
        .collect::<Vec<_>>()
        .join("\n");
    
    Ok(numbered)
}
```

### ç°æœ‰ RAG ç³»ç»Ÿ

**ä½ç½®**: `src/services/rag/`

- âœ… æœ‰ Markdown chunkerï¼ˆæŒ‰è¯­ä¹‰åˆ†å—ï¼‰
- âœ… æœ‰å‘é‡æœç´¢
- âœ… æœ‰ Reranker
- âŒ ä½† Agent æ²¡æœ‰ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼

---

## å·®è·å¯¹æ¯”

| åŠŸèƒ½ | Aider | Lumina Note | å·®è· |
|------|-------|-------------|------|
| **ç»“æ„æå–** | Tree-sitter AST | âŒ æ—  | éœ€å®ç° Markdown æ ‡é¢˜è§£æ |
| **ä»£ç /ç¬”è®° Map** | âœ… PageRank æ’åº | âŒ æ—  | æ ¸å¿ƒç¼ºå¤± |
| **æ¸è¿›å¼é˜…è¯»** | âœ… å…ˆéª¨æ¶åè¯¦æƒ… | âŒ å…¨é‡å–‚ç»™ LLM | æ ¸å¿ƒç¼ºå¤± |
| **Token é¢„ç®—** | âœ… äºŒåˆ†æœç´¢æ§åˆ¶ | âŒ æ—  | éœ€å®ç° |
| **åˆ†å±‚æ¶ˆæ¯** | âœ… ChatChunks | âŒ æ··åœ¨ä¸€èµ· | éœ€é‡æ„ |
| **ç²¾ç¡®ç¼–è¾‘** | âœ… SEARCH/REPLACE | âš ï¸ æœ‰ä½†æ²¡éªŒè¯ | éœ€åŠ å¼º |
| **è‡ªä¿®å¤** | âœ… 3æ¬¡é‡è¯• | âŒ æ—  | éœ€å®ç° |
| **æ ¼å¼æé†’** | âœ… system_reminder | âŒ æ—  | éœ€æ·»åŠ  |
| **å†å²æ‘˜è¦** | âœ… è‡ªåŠ¨æ‘˜è¦ | âŒ æ—  | å¯åæœŸå®ç° |
| **ç¼“å­˜** | âœ… SQLite ç¼“å­˜ tags | âŒ æ—  | éœ€å®ç° |

---

## æ”¹é€ è®¡åˆ’

### Phase 0: å¤šè½®å¯¹è¯å†å² âœ…

**ç›®æ ‡**: è®© Agent è®°ä½ä¹‹å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡

**å·²å®Œæˆ**:
- [x] 0.1 `TaskContext` å¢åŠ  `history` å­—æ®µ (`src-tauri/src/agent/types.rs`)
- [x] 0.2 `agent_start_task` ä½¿ç”¨å†å²åˆå§‹åŒ– `GraphState.messages` (`commands.rs`)
- [x] 0.3 `agent_worker_node` åœ¨ LLM è°ƒç”¨æ—¶åŒ…å«å†å²æ¶ˆæ¯ (`nodes.rs`)
- [x] 0.4 å‰ç«¯ `startTask` ä¼ å…¥å†å²æ¶ˆæ¯ (`useRustAgentStore.ts`)

**æ•ˆæœ**:
```
ç”¨æˆ·: å¸®æˆ‘çœ‹çœ‹ notes/æ—¥è®°.md
Agent: [è¯»å–å¹¶å›å¤]

ç”¨æˆ·: æŠŠç¬¬ä¸€æ®µæ”¹ç®€æ´ç‚¹
Agent: âœ… çŸ¥é“ä¸Šä¸‹æ–‡æ˜¯ notes/æ—¥è®°.mdï¼ˆå†å²æ¶ˆæ¯å·²ä¼ å…¥ï¼‰
```

---

### Phase 1: Note Mapï¼ˆç¬”è®°åº“åœ°å›¾ï¼‰âœ…

**ç›®æ ‡**: å®ç°ç±»ä¼¼ Repo Map çš„ç¬”è®°ç»“æ„æ‘˜è¦

**å·²å®Œæˆ**:
- [x] 1.1 åˆ›å»º `note_map` æ¨¡å—ç»“æ„ (`src-tauri/src/agent/note_map/`)
- [x] 1.2 Markdown æ ‡é¢˜è§£æå™¨ (`parser.rs`) - æå– # ## ### æ ‡é¢˜
- [x] 1.3 WikiLink æå–å™¨ - æå– `[[link]]` æ ¼å¼é“¾æ¥
- [x] 1.4 é“¾æ¥å›¾æ’åº (`ranking.rs`) - åŸºäºå¼•ç”¨è®¡æ•°æ’åº
- [x] 1.5 Note Map æ¸²æŸ“å™¨ (`renderer.rs`) - Token é¢„ç®—æ§åˆ¶
- [x] 1.6 é›†æˆåˆ° Agent èŠ‚ç‚¹ (`nodes.rs`)

**æ¨¡å—ç»“æ„**:
```
src-tauri/src/agent/note_map/
â”œâ”€â”€ mod.rs          # æ¨¡å—å…¥å£
â”œâ”€â”€ types.rs        # NoteTag, NoteLink, NoteMeta, RankedNote
â”œâ”€â”€ parser.rs       # Markdown è§£æã€WikiLink æå–
â”œâ”€â”€ ranking.rs      # å¼•ç”¨è®¡æ•°æ’åºã€PageRank
â””â”€â”€ renderer.rs     # Note Map æ¸²æŸ“ã€Token é¢„ç®—è£å‰ª
```

**è¾“å‡ºæ ¼å¼**:
```
ç¼–ç¨‹ç¬”è®°/Rust/æ‰€æœ‰æƒ.md:
â‹®...
â”‚# æ‰€æœ‰æƒ                        (L1, 584å­—)
â”‚  ## å€Ÿç”¨è§„åˆ™                   (L15, 328å­—)
â”‚  ## Move è¯­ä¹‰                  (L45, 256å­—)
â‹®...
```

**æ•ˆæœ**:
- Agent è·å¾—ç¬”è®°åº“ç»“æ„æ¦‚è§ˆï¼Œæ— éœ€å…¨é‡è¯»å–
- æŒ‰é‡è¦æ€§æ’åºï¼Œä¼˜å…ˆæ˜¾ç¤ºç›¸å…³ç¬”è®°
- Token é¢„ç®—æ§åˆ¶ï¼Œé»˜è®¤ 1024 tokens

### Phase 2: æ¸è¿›å¼è¯»å– âœ…

**ç›®æ ‡**: æ”¯æŒå¿«é€Ÿæ‰«æå¤§çº² + æŒ‰éœ€è¯»å–ç« èŠ‚

**è®¾è®¡ç†å¿µ**ï¼šæ–°å¢ä¸“é—¨çš„å¤§çº²å·¥å…·ï¼Œè€Œéæ”¹é€  `read_note`
- `read_outline` - æ‰¹é‡è¯»å–å¤šä¸ªç¬”è®°çš„å¤§çº²ç»“æ„
- `read_section` - è¯»å–æŒ‡å®šç« èŠ‚çš„è¯¦ç»†å†…å®¹

**å·²å®Œæˆ**:
- [x] 2.1 `read_outline` å·¥å…·å®šä¹‰ (`definitions.rs`)
- [x] 2.2 `read_outline` å·¥å…·æ‰§è¡Œå™¨ (`registry.rs`)
- [x] 2.3 `read_section` å·¥å…·å®šä¹‰
- [x] 2.4 `read_section` å·¥å…·æ‰§è¡Œå™¨
- [x] 2.5 æ³¨å†Œåˆ° editor/researcher å·¥å…·åˆ—è¡¨

**å·¥å…·è®¾è®¡**:

```rust
// read_outline - æ‰¹é‡æ‰«æå¤§çº²
read_outline(paths: ["ç¬”è®°1.md", "ç¬”è®°2.md", "ç¬”è®°3.md"])
// è¾“å‡º:
// ğŸ“„ ç¬”è®°1.md (æ ‡é¢˜)
// #  ç¬¬ä¸€ç«  (L1, 500å­—)
//   ##  1.1 æ¦‚è¿° (L5, 200å­—)
//   ##  1.2 è¯¦æƒ… (L20, 300å­—)
//    â†’ 3 ä¸ªå‡ºé“¾

// read_section - è¯»å–æŒ‡å®šç« èŠ‚
read_section(path: "ç¬”è®°1.md", section: "1.1 æ¦‚è¿°")
// è¾“å‡º: å¸¦è¡Œå·çš„ç« èŠ‚å†…å®¹
```

**ä½¿ç”¨åœºæ™¯**:
```
ç”¨æˆ·: å¸®æˆ‘æ‰¾æ‰¾å…³äº React Hooks çš„ç¬”è®°åœ¨å“ªé‡Œ

Agent:
1. semantic_search("React Hooks") â†’ å¾—åˆ°å€™é€‰ç¬”è®°åˆ—è¡¨
2. read_outline(["å‰ç«¯/React.md", "ç¬”è®°/Hooks.md", ...]) â†’ å¹¶è¡Œæ‰«æå¤§çº²
3. å‘ç° "å‰ç«¯/React.md" æœ‰ "## useEffect" ç« èŠ‚
4. read_section("å‰ç«¯/React.md", "useEffect") â†’ è¯»å–è¯¦æƒ…
5. å›ç­”ç”¨æˆ·
```

---

#### 2.1 åŸè®¾è®¡ï¼ˆå·²åºŸå¼ƒï¼‰

```rust
// åŸæ–¹æ¡ˆï¼šæ”¹é€  read_note å¢åŠ  section å‚æ•°
async fn read_note(&self, params: ...) -> Result<String, String> {
    let path = params.get("path")?;
    let section = params.get("section");  // å¯é€‰ï¼šç« èŠ‚æ ‡é¢˜
    let lines = params.get("lines");       // å¯é€‰ï¼šè¡ŒèŒƒå›´ "15-44"
    
    if let Some(heading) = section {
        // åªè¿”å›æŒ‡å®šç« èŠ‚çš„å†…å®¹
        return extract_section(content, heading);
    }
    
    if let Some(range) = lines {
        // åªè¿”å›æŒ‡å®šè¡ŒèŒƒå›´
        return extract_lines(content, range);
    }
    
    // é»˜è®¤ï¼šè¿”å›å¤§çº²ï¼ˆä¸æ˜¯å…¨æ–‡ï¼ï¼‰
    return extract_outline(content);
}
```

#### 2.2 å·¥å…·å®šä¹‰æ›´æ–°

```json
{
  "name": "read_note",
  "description": "è¯»å–ç¬”è®°å†…å®¹ã€‚é»˜è®¤è¿”å›å¤§çº²ï¼Œå¯æŒ‡å®šç« èŠ‚æˆ–è¡ŒèŒƒå›´è·å–è¯¦æƒ…ã€‚",
  "parameters": {
    "path": { "type": "string", "description": "ç¬”è®°è·¯å¾„" },
    "section": { "type": "string", "description": "å¯é€‰ï¼šè¦è¯»å–çš„ç« èŠ‚æ ‡é¢˜" },
    "lines": { "type": "string", "description": "å¯é€‰ï¼šè¡ŒèŒƒå›´ï¼Œå¦‚ '15-44'" }
  }
}
```

### Phase 3: åˆ†å±‚æ¶ˆæ¯æ¶æ„ âœ…

**ç›®æ ‡**: é‡æ„æ¶ˆæ¯æ„å»ºï¼Œç±»ä¼¼ Aider çš„ ChatChunks

**å·²å®Œæˆ**:
- [x] 3.1 åˆ›å»º `ChatChunks` ç»“æ„ä½“ (`src-tauri/src/agent/messages/chunks.rs`)
- [x] 3.2 Note Map å¯¹è¯æ³¨å…¥ï¼ˆuser/assistant ä¸€é—®ä¸€ç­”ï¼‰
- [x] 3.3 å½“å‰ç¬”è®°ç‹¬ç«‹æ¶ˆæ¯å—
- [x] 3.4 åŸºç¡€æ ¼å¼æé†’ + åŠ¨æ€æé†’å‡½æ•°
- [x] 3.5 é‡æ„ `agent_worker_node` ä½¿ç”¨ `ChatChunks`

**æ¨¡å—ç»“æ„**:
```
src-tauri/src/agent/messages/
â”œâ”€â”€ mod.rs          # æ¨¡å—å…¥å£
â””â”€â”€ chunks.rs       # ChatChunks å®ç°
```

**æ¶ˆæ¯é¡ºåº**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. System: èº«ä»½ + è§„åˆ™ + æ ¼å¼æé†’   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. User: "ç¬”è®°åº“ç»“æ„..."            â”‚  â† Note Map
â”‚ 3. Assistant: "å¥½çš„ï¼Œæˆ‘å·²äº†è§£"      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. User: "å½“å‰ç¬”è®°: ..."            â”‚  â† å½“å‰ç¼–è¾‘çš„ç¬”è®°
â”‚ 5. Assistant: "å¥½çš„"                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. User: "RAG æœç´¢ç»“æœ..."          â”‚  â† è¯­ä¹‰æœç´¢ç»“æœ
â”‚ 7. Assistant: "å¥½çš„"                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 8. å†å²å¯¹è¯æ¶ˆæ¯...                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 9. User: å½“å‰ä»»åŠ¡                   â”‚
â”‚ 10. User: [å·¥å…·æ‰§è¡Œç»“æœ]...         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11. User: [ç³»ç»Ÿæé†’]ï¼ˆå¦‚æœ‰ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡å†³ç­–**:
- Note Map ç”¨å¯¹è¯æ³¨å…¥ï¼Œè®©æ¨¡å‹"è®°ä½"å·²çœ‹è¿‡
- å½“å‰ç¬”è®°ç‹¬ç«‹æ¶ˆæ¯å—ï¼Œå’Œåªè¯»å¤§çº²åŒºåˆ†
- å·¥å…·ç»“æœç”¨ user è§’è‰²ï¼Œå…¼å®¹æ‰€æœ‰æ¨¡å‹
- å†å²è£å‰ªæš‚æœªå®ç°ï¼ˆç®€å• FIFO è¶³å¤Ÿï¼‰

### Phase 4: è‡ªä¿®å¤ä¸æ ¼å¼æé†’ âœ…

**ç›®æ ‡**: å¸®åŠ© LLM è‡ªåŠ¨ä»é”™è¯¯ä¸­æ¢å¤

**å·²å®Œæˆ**:
- [x] 4.1 å¢å¼º `edit_note` é”™è¯¯ä¿¡æ¯ï¼ˆè¯Šæ–­ + å»ºè®®ï¼‰
- [x] 4.2 åœ¨å·¥å…·è°ƒç”¨å¾ªç¯ä¸­ä½¿ç”¨åŠ¨æ€æé†’
- [x] 4.3 åŸºç¡€æ ¼å¼æé†’ï¼ˆåœ¨ Phase 3 å®Œæˆï¼‰

**edit_note é”™è¯¯è¯Šæ–­**:
```rust
// æ™ºèƒ½è¯Šæ–­é—®é¢˜åŸå› 
if content.contains(old_trimmed) {
    "æç¤ºï¼šå»æ‰é¦–å°¾ç©ºç™½åèƒ½æ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ old_string çš„é¦–å°¾ç©ºæ ¼/æ¢è¡Œ"
} else if content.to_lowercase().contains(&old_string.to_lowercase()) {
    "æç¤ºï¼šå¿½ç•¥å¤§å°å†™åèƒ½æ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥å¤§å°å†™æ˜¯å¦åŒ¹é…"
} else {
    // æ˜¾ç¤ºæ–‡ä»¶å‰10è¡Œå¸®åŠ©å®šä½
}
```

**åŠ¨æ€æé†’æœºåˆ¶**:
```rust
// å·¥å…·æ‰§è¡Œå¤±è´¥åè‡ªåŠ¨æ·»åŠ æé†’
if !result.success {
    if let Some(reminder) = detect_reminder_needed(result.error.as_deref()) {
        messages.push(Message {
            role: MessageRole::User,
            content: format!("[ç³»ç»Ÿæé†’] {}", reminder),
        });
    }
}
```

**æ•ˆæœ**:
- ç¼–è¾‘å¤±è´¥æ—¶ï¼ŒLLM èƒ½ç†è§£å¤±è´¥åŸå› 
- ç³»ç»Ÿè‡ªåŠ¨æé†’"è¯·é‡æ–° read_note è·å–æœ€æ–°å†…å®¹"
- LLM å¯ä»¥è‡ªåŠ¨é‡è¯•ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„

#### 4.2 æ ¼å¼æé†’

```rust
fn get_reminder_messages(&self) -> Vec<Message> {
    vec![
        Message {
            role: "system",
            content: r#"
æé†’ï¼š
1. ä½¿ç”¨ read_note æ—¶ï¼Œå…ˆä¸å¸¦å‚æ•°è·å–å¤§çº²ï¼Œéœ€è¦è¯¦æƒ…å†æŒ‡å®š section
2. ç¼–è¾‘ç¬”è®°æ—¶ï¼Œold_string å¿…é¡»ç²¾ç¡®åŒ¹é…ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œæ¢è¡Œ
3. å¦‚æœç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡æ–°è¯»å–æ–‡ä»¶ç¡®è®¤å†…å®¹åå†å°è¯•
"#.to_string(),
        },
    ]
}
```

### Phase 5: Token é¢„ç®—æ§åˆ¶

```rust
// src-tauri/src/agent/note_map/budget.rs

fn fit_to_token_budget(
    ranked_notes: &[RankedNote],
    max_tokens: usize,
) -> Vec<RankedNote> {
    // äºŒåˆ†æœç´¢æ‰¾åˆ°æœ€ä¼˜æ•°é‡
    let mut lower = 0;
    let mut upper = ranked_notes.len();
    let mut best = vec![];
    
    while lower <= upper {
        let mid = (lower + upper) / 2;
        let subset: Vec<_> = ranked_notes.iter().take(mid).cloned().collect();
        let rendered = render_note_map(&subset);
        let tokens = count_tokens(&rendered);
        
        if tokens <= max_tokens {
            best = subset;
            lower = mid + 1;
        } else {
            upper = mid - 1;
        }
    }
    
    best
}
```

### Phase 6: ç¼“å­˜ç³»ç»Ÿ

```rust
// src-tauri/src/agent/note_map/cache.rs

/// Note Map ç¼“å­˜
struct NoteMapCache {
    db: SqliteConnection,
}

impl NoteMapCache {
    /// è·å–ç¬”è®°æ ‡ç­¾ï¼ˆå¸¦ç¼“å­˜ï¼‰
    fn get_tags(&self, path: &str) -> Vec<NoteTag> {
        let mtime = fs::metadata(path)?.modified()?;
        
        // æ£€æŸ¥ç¼“å­˜
        if let Some(cached) = self.db.get(path) {
            if cached.mtime == mtime {
                return cached.tags;
            }
        }
        
        // é‡æ–°è§£æ
        let content = fs::read_to_string(path)?;
        let (tags, _) = parse_markdown(&content);
        
        // æ›´æ–°ç¼“å­˜
        self.db.insert(path, mtime, &tags);
        
        tags
    }
}
```

---

## å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | Phase | é¢„è®¡å·¥ä½œé‡ | é€Ÿåº¦æ”¶ç›Š | Token æ”¶ç›Š |
|--------|-------|-----------|---------|-----------|
| ğŸ”´ é«˜ | Phase 1: Note Map | 3-4 å¤© | +30% | -60% |
| ğŸ”´ é«˜ | Phase 2: æ¸è¿›å¼è¯»å– | 1-2 å¤© | +20% | -50% |
| ğŸŸ¡ ä¸­ | Phase 3: åˆ†å±‚æ¶ˆæ¯ | 2-3 å¤© | +10% | -10% |
| ğŸŸ¡ ä¸­ | Phase 4: è‡ªä¿®å¤ | 1 å¤© | +15% (å‡å°‘é‡è¯•) | - |
| ğŸŸ¢ ä½ | Phase 5: Token é¢„ç®— | 1 å¤© | +5% | -20% |
| ğŸŸ¢ ä½ | Phase 6: ç¼“å­˜ | 1-2 å¤© | +10% | - |

### ç´¯è®¡æ”¶ç›Šé¢„ä¼°

å®Œæˆæ‰€æœ‰ Phase åçš„é¢„æœŸæ•ˆæœï¼š

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **Agent å•æ¬¡å“åº”** | ~10s | ~4-5s | **50%+** |
| **Deep Research æµç¨‹** | ~3min | ~1-1.5min | **50%+** |
| **Token æ¶ˆè€— (Agent)** | 100% | ~30% | **-70%** |
| **Token æ¶ˆè€— (Research)** | 100% | ~40% | **-60%** |
| **ç¼–è¾‘æˆåŠŸç‡** | ~70% | ~95% | **+25%** |
| **API æˆæœ¬** | 100% | ~35% | **-65%** |

### å®æ–½è·¯çº¿å›¾

```
Week 1: Phase 1 + Phase 2 (æ ¸å¿ƒåŠŸèƒ½)
        â”œâ”€â”€ Note Map å®ç°
        â””â”€â”€ read_note æ”¹é€ 
              â†“
        åˆæ­¥æµ‹è¯•ï¼šé¢„æœŸé€Ÿåº¦ +40%, Token -50%
              â†“
Week 2: Phase 3 + Phase 4 (æ¶æ„ä¼˜åŒ–)
        â”œâ”€â”€ åˆ†å±‚æ¶ˆæ¯
        â””â”€â”€ è‡ªä¿®å¤æœºåˆ¶
              â†“
        äºŒæ¬¡æµ‹è¯•ï¼šé¢„æœŸé€Ÿåº¦ +50%, Token -60%
              â†“
Week 3: Phase 5 + Phase 6 (ç²¾ç»†ä¼˜åŒ–)
        â”œâ”€â”€ Token é¢„ç®—
        â””â”€â”€ ç¼“å­˜ç³»ç»Ÿ
              â†“
        æœ€ç»ˆæ•ˆæœï¼šé€Ÿåº¦ +50%, Token -70%
```

---

## Phase 7: Plan UI ä¸ä»»åŠ¡ç®¡ç† âœ…

**ç›®æ ‡**: å®ç°ç±»ä¼¼ Cursor çš„ä»»åŠ¡è®¡åˆ’ UIï¼Œè®© Agent æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–

### å·²å®Œæˆ

- [x] 7.1 `create_plan` å·¥å…· - åˆ›å»ºæ‰§è¡Œè®¡åˆ’
- [x] 7.2 `update_plan_progress` å·¥å…· - æ›´æ–°æ­¥éª¤è¿›åº¦
- [x] 7.3 å‰ç«¯ `PlanCard` ç»„ä»¶ - æ˜¾ç¤ºè®¡åˆ’å’Œè¿›åº¦
- [x] 7.4 åç«¯å¼ºåˆ¶å®Œæˆæœºåˆ¶ - é˜»æ­¢æå‰ç»“æŸ
- [x] 7.5 è¯¦ç»†åé¦ˆæœºåˆ¶ - è®© LLM äº†è§£å½“å‰è¿›åº¦

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è°ƒç”¨ create_plan                                        â”‚
â”‚  â†’ åç«¯åˆ›å»ºè®¡åˆ’ï¼Œå‘é€ PlanCreated äº‹ä»¶                        â”‚
â”‚  â†’ å‰ç«¯æ˜¾ç¤º PlanCard                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æ‰§è¡Œä»»åŠ¡ï¼Œè°ƒç”¨ update_plan_progress                      â”‚
â”‚  â†’ åç«¯æ›´æ–°æ­¥éª¤çŠ¶æ€ï¼Œå‘é€ StepCompleted äº‹ä»¶                   â”‚
â”‚  â†’ å‰ç«¯æ›´æ–° PlanCard æ˜¾ç¤º âœ“                                  â”‚
â”‚  â†’ è¿”å›è¯¦ç»†åé¦ˆï¼š"âœ… æ­¥éª¤ 2 å®Œæˆï¼Œå¾…å®Œæˆï¼š3. xxx"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è°ƒç”¨ attempt_completion                                 â”‚
â”‚  â†’ åç«¯æ£€æŸ¥ï¼šæ‰€æœ‰æ­¥éª¤éƒ½å®Œæˆäº†å—ï¼Ÿ                              â”‚
â”‚     â”œâ”€â”€ YES â†’ å…è®¸ç»“æŸ                                       â”‚
â”‚     â””â”€â”€ NO â†’ æ‹’ç»ï¼è¿”å›"è¿˜æœ‰ X ä¸ªæ­¥éª¤æœªå®Œæˆ"ï¼Œcontinue å¾ªç¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

#### å·¥å…·å®šä¹‰ (`definitions.rs`)

```rust
pub fn create_plan_definition() -> ToolDefinition {
    ToolDefinition {
        name: "create_plan".to_string(),
        description: "åˆ›å»ºæ‰§è¡Œè®¡åˆ’ã€‚åœ¨å¼€å§‹ä»»åŠ¡å‰å¿…é¡»è°ƒç”¨æ­¤å·¥å…·ã€‚".to_string(),
        parameters: json!({
            "type": "object",
            "properties": {
                "steps": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "id": { "type": "string" },
                            "description": { "type": "string" }
                        }
                    }
                }
            },
            "required": ["steps"]
        }),
    }
}

pub fn update_plan_progress_definition() -> ToolDefinition {
    ToolDefinition {
        name: "update_plan_progress".to_string(),
        description: "æ›´æ–°è®¡åˆ’æ­¥éª¤çš„è¿›åº¦ã€‚å®Œæˆä¸€ä¸ªæ­¥éª¤åè°ƒç”¨ã€‚".to_string(),
        parameters: json!({
            "type": "object",
            "properties": {
                "step_id": { "type": "string" },
                "status": { "type": "string", "enum": ["completed", "skipped"] }
            },
            "required": ["step_id", "status"]
        }),
    }
}
```

#### å¼ºåˆ¶å®Œæˆæ£€æŸ¥ (`nodes.rs`)

```rust
if tool_call.name == "attempt_completion" {
    let all_steps_completed = state.current_plan.as_ref()
        .map(|plan| plan.steps.iter().all(|s| s.completed))
        .unwrap_or(true);
    
    if !all_steps_completed && iteration < max_iterations - 1 {
        // æ‹’ç»ç»“æŸï¼Œè¿”å›æç¤º
        messages.push(Message {
            role: MessageRole::User,
            content: format!(
                "[ç³»ç»Ÿæé†’] âš ï¸ æ‹’ç»ç»“æŸï¼è®¡åˆ’ä¸­è¿˜æœ‰ {} ä¸ªæ­¥éª¤æœªå®Œæˆï¼š\n{}\n\nè¯·ç»§ç»­æ‰§è¡Œ...",
                incomplete_count,
                pending.join("\n")
            ),
        });
        continue; // è·³è¿‡ï¼Œç»§ç»­å¾ªç¯
    }
}
```

#### è¯¦ç»†åé¦ˆ (`nodes.rs`)

```rust
// update_plan_progress è¿”å›è¯¦ç»†çŠ¶æ€
feedback = format!(
    "âœ… æ­¥éª¤ {}ã€Œ{}ã€å·²å®Œæˆã€‚\nå½“å‰è¿›åº¦ï¼š{}/{}\n{}",
    step_id,
    step_desc,
    completed_count,
    plan.steps.len(),
    if pending.is_empty() { 
        "æ‰€æœ‰æ­¥éª¤å·²å®Œæˆï¼Œè¯·è°ƒç”¨ attempt_completion ç»“æŸä»»åŠ¡ã€‚".to_string()
    } else { 
        format!("å¾…å®Œæˆï¼š{}", pending.join("ï¼Œ")) 
    }
);
```

### Prompt è§„åˆ™

```
RULES

1. **å¼€å§‹ä»»åŠ¡å‰å¿…é¡»å…ˆè°ƒç”¨ create_plan åˆ›å»ºæ‰§è¡Œè®¡åˆ’**
   - å°†ä»»åŠ¡æ‹†è§£ä¸º 1-5 ä¸ªå…·ä½“æ­¥éª¤
   - æ¯ä¸ªæ­¥éª¤æœ‰å”¯ä¸€ ID å’Œæ¸…æ™°æè¿°

2. **å®Œæˆæ¯ä¸ªæ­¥éª¤åå¿…é¡»ç«‹å³è°ƒç”¨ update_plan_progress æ ‡è®°è¿›åº¦**
   - step_id: æ­¥éª¤ IDï¼ˆæ•°å­—å­—ç¬¦ä¸²å¦‚ "1", "2", "3"ï¼‰
   - status: "completed" æˆ– "skipped"
   - æ‰§è¡Œé¡ºåºï¼šæ‰§è¡Œæ­¥éª¤ â†’ ç«‹å³æ ‡è®°è¯¥æ­¥éª¤å®Œæˆ â†’ æ‰§è¡Œä¸‹ä¸€æ­¥éª¤

7. **attempt_completion åªèƒ½åœ¨æ‰€æœ‰è®¡åˆ’æ­¥éª¤éƒ½å®Œæˆåè°ƒç”¨**
   - âŒ ç¦æ­¢ï¼šè¿˜æœ‰æœªå®Œæˆæ­¥éª¤æ—¶è°ƒç”¨ attempt_completion
   - âœ… æ­£ç¡®ï¼šæ¯ä¸ªæ­¥éª¤å®Œæˆåè°ƒç”¨ update_plan_progressï¼Œå…¨éƒ¨å®Œæˆåå†è°ƒç”¨ attempt_completion
   - å¦‚æœæå‰è°ƒç”¨ï¼Œç³»ç»Ÿä¼šæ‹’ç»å¹¶è¦æ±‚ä½ ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
```

### å‰ç«¯äº‹ä»¶å¤„ç† (`useRustAgentStore.ts`)

```typescript
// plan_created äº‹ä»¶
case 'plan_created':
  set({ currentPlan: event.data });
  break;

// step_completed äº‹ä»¶
case 'step_completed':
  set((state) => {
    if (!state.currentPlan) return state;
    const steps = [...state.currentPlan.steps];
    if (event.data.index < steps.length) {
      steps[event.data.index] = { ...steps[event.data.index], completed: true };
    }
    return { currentPlan: { ...state.currentPlan, steps, current_step: event.data.index + 1 } };
  });
  break;
```

### æ•ˆæœ

1. **å¯è§†åŒ–è¿›åº¦** - ç”¨æˆ·èƒ½çœ‹åˆ° Agent æ­£åœ¨æ‰§è¡Œå“ªä¸ªæ­¥éª¤
2. **é˜²æ­¢æå‰ç»“æŸ** - LLM å¿…é¡»å®Œæˆæ‰€æœ‰æ­¥éª¤æ‰èƒ½ç»“æŸ
3. **è‡ªåŠ¨æ¢å¤** - å¦‚æœ LLM è¿è§„ï¼Œç³»ç»Ÿä¼šæ‹’ç»å¹¶æç¤ºç»§ç»­

---

## å‚è€ƒèµ„æº

- [Aider GitHub](https://github.com/Aider-AI/aider)
- [Aider Repo Map æ–‡æ¡£](https://aider.chat/docs/repomap.html)
- [Building a better repository map with tree sitter](https://aider.chat/2023/10/22/repomap.html)
- æœ¬åœ° Aider æºç : `d:\Desktop\Lumina Note\aider\`

---

## é™„å½•ï¼šå…³é”®ä»£ç ä½ç½®

### Aider æºç 

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `aider/repomap.py` | Repo Map æ ¸å¿ƒé€»è¾‘ |
| `aider/coders/base_coder.py` | æ¶ˆæ¯æ„å»ºã€ä¸Šä¸‹æ–‡ç®¡ç† |
| `aider/coders/base_prompts.py` | æç¤ºè¯æ¨¡æ¿ |
| `aider/coders/editblock_prompts.py` | SEARCH/REPLACE æ ¼å¼å®šä¹‰ |
| `aider/coders/chat_chunks.py` | åˆ†å±‚æ¶ˆæ¯ç»“æ„ |
| `aider/queries/*.scm` | Tree-sitter æŸ¥è¯¢æ–‡ä»¶ |

### Lumina Note éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `src-tauri/src/agent/note_map/` | æ–°å¢ï¼šNote Map æ¨¡å— |
| `src-tauri/src/agent/tools/registry.rs` | æ”¹é€ ï¼šread_note æ”¯æŒç« èŠ‚è¯»å– |
| `src-tauri/src/agent/tools/definitions.rs` | æ›´æ–°ï¼šå·¥å…·å®šä¹‰ |
| `src-tauri/src/agent/graph/nodes.rs` | æ”¹é€ ï¼šæ¶ˆæ¯æ„å»ºé€»è¾‘ |
| `src-tauri/src/agent/deep_research/nodes.rs` | æ”¹é€ ï¼šä½¿ç”¨ Note Map |
